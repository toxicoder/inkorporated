# Post-Setup Playbook
# Performs post-installation configuration tasks

---
- name: Configure k3s cluster post-setup
  hosts: control_plane
  become: yes
  vars:
    k3s_config_dir: "/etc/rancher/k3s"
    k3s_data_dir: "/var/lib/rancher/k3s"
  
  tasks:
    - name: Create k3s config directory
      file:
        path: "{{ k3s_config_dir }}"
        state: directory
        mode: '0755'

    - name: Install required k3s addons
      command: k3s kubectl apply -f {{ item }}
      loop:
        - "{{ k3s_config_dir }}/addons/traefik.yaml"
        - "{{ k3s_config_dir }}/addons/local-path-storage.yaml"
        - "{{ k3s_config_dir }}/addons/metrics-server.yaml"
      when: ansible_host is defined

    - name: Wait for addons to be ready
      command: k3s kubectl get pods -n {{ item }} -o json
      loop:
        - kube-system
        - local-path-storage
      register: addon_pods
      changed_when: false
      failed_when: false
      retries: 10
      delay: 10
      until: "'Ready' in (addon_pods.stdout | from_json | json_query('items[*].status.conditions[?type==`Ready`].status') | flatten | join(','))"

    - name: Configure storage classes
      command: k3s kubectl apply -f {{ k3s_config_dir }}/storage/storage-class.yaml
      when: ansible_host is defined

    - name: Configure monitoring stack
      command: k3s kubectl apply -f {{ k3s_config_dir }}/monitoring/monitoring.yaml
      when: ansible_host is defined

    - name: Verify cluster health
      command: k3s kubectl get nodes -o wide
      register: nodes_status
      changed_when: false
      failed_when: false

    - name: Display cluster nodes
      debug:
        msg: "Cluster nodes: {{ nodes_status.stdout }}"

    - name: Get cluster version
      command: k3s kubectl version
      register: k8s_version
      changed_when: false
      failed_when: false

    - name: Display k8s version
      debug:
        msg: "Kubernetes version: {{ k8s_version.stdout }}"

    - name: Configure network policies
      command: k3s kubectl apply -f {{ k3s_config_dir }}/network/network-policies.yaml
      when: ansible_host is defined

    - name: Setup DNS configuration
      command: k3s kubectl apply -f {{ k3s_config_dir }}/dns/dns-config.yaml
      when: ansible_host is defined

    - name: Final cluster status check
      command: k3s kubectl cluster-info
      register: final_cluster_info
      changed_when: false
      failed_when: false

    - name: Display final cluster info
      debug:
        msg: "Final cluster info: {{ final_cluster_info.stdout }}"
