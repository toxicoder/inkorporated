# ArgoCD Installation Role
# Tasks for installing and configuring ArgoCD

---
- name: Create ArgoCD namespace
  command: k3s kubectl create namespace argocd
  args:
    creates: /dev/null
  changed_when: false

- name: Install ArgoCD
  command: k3s kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
  args:
    creates: /dev/null
  changed_when: false

- name: Wait for ArgoCD to be ready
  command: k3s kubectl get pods -n argocd -l app.kubernetes.io/name=argocd-server -o json
  register: argocd_pods
  changed_when: false
  failed_when: false
  retries: 20
  delay: 10
  until: "'Ready' in (argocd_pods.stdout | from_json | json_query('items[*].status.conditions[?type==`Ready`].status') | flatten | join(','))"

- name: Get ArgoCD admin password
  command: k3s kubectl get secret -n argocd argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d
  register: argocd_password
  changed_when: false
  failed_when: false

- name: Display ArgoCD password
  debug:
    msg: "ArgoCD admin password: {{ argocd_password.stdout }}"

- name: Expose ArgoCD service
  command: k3s kubectl patch svc argocd-server -n argocd -p '{"spec":{"type":"LoadBalancer"}}'
  args:
    creates: /dev/null
  changed_when: false

- name: Wait for ArgoCD service to be ready
  command: k3s kubectl get svc argocd-server -n argocd -o json
  register: argocd_service
  changed_when: false
  failed_when: false
  retries: 10
  delay: 10
  until: "'LoadBalancer' in (argocd_service.stdout | from_json | json_query('spec.type'))"

- name: Get ArgoCD service IP
  command: k3s kubectl get svc argocd-server -n argocd -o jsonpath='{.status.loadBalancer.ingress[0].ip}'
  register: argocd_ip
  changed_when: false
  failed_when: false

- name: Display ArgoCD service info
  debug:
    msg: "ArgoCD is available at: http://{{ argocd_ip.stdout }}:80"
